
name: CI-CD

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

env:
  # main → production, develop → staging
  ENVIRONMENT: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
  SHORT_SHA: ${{ github.sha[0:7] }}

jobs:
  ##############################
  # 1. Install + Test (Root)
  ##############################
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install root deps (if monorepo)
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No root-level package.json (monorepo)"
          fi

      - name: Install backend deps
        working-directory: backend
        run: npm ci

      - name: Build backend
        working-directory: backend
        run: npm run build

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Run backend tests
        working-directory: backend
        run: npm test

  ##############################
  # 2. Build Backend Image
  ##############################
  docker-build-backend:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build backend image
        run: |
          docker build \
            -f backend/Dockerfile \
            -t tipspay-backend:${{ env.SHORT_SHA }} \
            -t tipspay-backend:${{ env.ENVIRONMENT }} \
            backend

  ##############################
  # 3. Build Frontend Image
  ##############################
  docker-build-frontend:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build frontend image
        run: |
          docker build \
            -f frontend/Dockerfile \
            -t tipspay-frontend:${{ env.SHORT_SHA }} \
            -t tipspay-frontend:${{ env.ENVIRONMENT }} \
            frontend

  ##############################
  # 4. Deploy Backend to Hyperlift
  ##############################
  deploy-backend:
    runs-on: ubuntu-latest
    needs: docker-build-backend

    env:
      HAPI: ${{ secrets.HYPERLIFT_API_TOKEN }}
      WH: ${{ secrets.HYPERLIFT_DEPLOY_WEBHOOK }}
      ENVIRONMENT: ${{ env.ENVIRONMENT }}
      SHORT_SHA: ${{ env.SHORT_SHA }}

    steps:
      - name: Deploy backend to Hyperlift
        run: |
          curl -X POST "$WH" \
            -H "Authorization: Bearer $HAPI" \
            -H "Content-Type: application/json" \
            -d "{
              \"service\": \"tipspay-backend\",
              \"environment\": \"${ENVIRONMENT}\",
              \"image\": \"tipspay-backend:${SHORT_SHA}\"
            }"

  ##############################
  # 5. Deploy Frontend to Hyperlift
  ##############################
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: docker-build-frontend

    env:
      HAPI: ${{ secrets.HYPERLIFT_API_TOKEN }}
      WH: ${{ secrets.HYPERLIFT_DEPLOY_WEBHOOK }}
      ENVIRONMENT: ${{ env.ENVIRONMENT }}
      SHORT_SHA: ${{ env.SHORT_SHA }}

    steps:
      - name: Deploy frontend to Hyperlift
        run: |
          curl -X POST "$WH" \
            -H "Authorization: Bearer $HAPI" \
            -H "Content-Type: application/json" \
            -d "{
              \"service\": \"tipspay-frontend\",
              \"environment\": \"${ENVIRONMENT}\",
              \"image\": \"tipspay-frontend:${SHORT_SHA}\"
            }"
